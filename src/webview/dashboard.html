<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'none'; 
                   style-src {{cspSource}} 'unsafe-inline'; 
                   script-src 'nonce-{{nonce}}'; 
                   img-src {{cspSource}} data: https:; 
                   font-src {{cspSource}};">
    <link rel="stylesheet" href="{{highlightCssUri}}">
    <link rel="stylesheet" href="{{codiconsUri}}">
    <title>Specs Dashboard</title>
    <style nonce="{{nonce}}">
        /* Native IDE Styling - VSCode Design System */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--vscode-font-family);
            font-size: 13px;
            color: var(--vscode-foreground);
            background: var(--vscode-sideBar-background);
            line-height: 1.4;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            padding: 0;
            width: 100%;
        }

        /* Statistics Header - Compact, Inline */
        .stats-header {
            background: var(--vscode-sideBarSectionHeader-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 11px;
        }

        .stats-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1 1 auto;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap;
        }

        .stat-value {
            font-family: var(--vscode-editor-font-family);
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .button-row {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
        }

        .analytics-button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 12px;
            border-radius: 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 11px;
            font-family: var(--vscode-font-family);
            border-right: 1px solid rgba(0, 0, 0, 0.2);
            flex: 1;
        }

        .analytics-button:last-child {
            border-right: none;
        }

        .analytics-button:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .analytics-button:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .analytics-button .codicon {
            font-size: 14px;
        }

        /* Filter Controls - Native Input Styling */
        .filter-controls {
            background: var(--vscode-sideBar-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            padding: 8px 12px;
        }

        .search-input {
            width: 100%;
            padding: 4px 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 13px;
            outline: none;
            margin-bottom: 8px;
        }

        .search-input:focus {
            border-color: var(--vscode-focusBorder);
        }

        .search-input::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }

        .filter-buttons {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .filter-btn {
            flex: 1;
            padding: 4px 8px;
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .filter-btn:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        .filter-btn.active {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .filter-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }

        .items-per-page select {
            padding: 2px 4px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            outline: none;
        }

        .items-per-page select:focus {
            border-color: var(--vscode-focusBorder);
        }

        /* Spec List - Flat, List-Based Layout */
        .spec-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .spec-item {
            border-bottom: 1px solid var(--vscode-panel-border);
            padding: 12px 12px 16px 12px;
            cursor: pointer;
        }
        
        .spec-item:nth-child(even) {
            background: var(--vscode-sideBar-background);
        }
        
        .spec-item:nth-child(odd) {
            background: rgba(255, 255, 255, 0.02);
        }

        .spec-item:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .spec-item:active {
            background: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .spec-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .spec-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .spec-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            font-size: 10px;
            font-weight: 600;
            border-radius: 2px;
        }

        .spec-path {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-bottom: 6px;
        }

        .workspace-folder {
            font-family: var(--vscode-editor-font-family);
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
            opacity: 0.8;
            margin-right: 4px;
        }

        .spec-progress-bar {
            height: 2px;
            background: var(--vscode-editorWidget-background);
            margin-bottom: 6px;
            overflow: hidden;
        }

        .spec-progress-fill {
            height: 100%;
            background: var(--vscode-progressBar-background);
            transition: width 0.2s;
        }

        .spec-stats {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            font-family: var(--vscode-editor-font-family);
        }

        .spec-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .spec-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .action-btn {
            padding: 2px 8px;
            background: transparent;
            color: var(--vscode-button-foreground);
            border: 1px solid var(--vscode-button-border);
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .action-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        /* Execution Controls */
        .execution-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }

        .execution-btn-wrapper {
            position: relative;
            display: inline-block;
        }

        .execution-btn {
            padding: 4px 12px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .execution-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .execution-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .execution-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .execution-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 2px;
            background: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 2px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .execution-dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--vscode-dropdown-foreground);
        }

        .execution-dropdown-item:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .execution-dropdown-item .codicon {
            font-size: 14px;
        }

        .execution-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 600;
        }

        .execution-status.running {
            background: var(--vscode-statusBarItem-warningBackground);
            color: var(--vscode-statusBarItem-warningForeground);
        }

        .execution-status.completed {
            background: var(--vscode-testing-iconPassed);
            color: var(--vscode-button-foreground);
        }

        .execution-status.failed {
            background: var(--vscode-statusBarItem-errorBackground);
            color: var(--vscode-statusBarItem-errorForeground);
        }

        .execution-status.cancelled {
            background: var(--vscode-descriptionForeground);
            color: var(--vscode-button-foreground);
        }

        .execution-progress {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            font-family: var(--vscode-editor-font-family);
        }

        .cancel-btn {
            padding: 2px 8px;
            background: var(--vscode-statusBarItem-errorBackground);
            color: var(--vscode-statusBarItem-errorForeground);
            border: none;
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            /* HIDDEN: Simplified UI - cancel execution feature hidden for now */
            display: none !important;
        }

        .cancel-btn:hover {
            opacity: 0.8;
        }

        .cancel-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        /* Empty State */
        .empty-state {
            padding: 32px 20px;
            text-align: center;
            color: var(--vscode-descriptionForeground);
        }

        .empty-state-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--vscode-foreground);
        }

        .empty-state-text {
            font-size: 12px;
            line-height: 1.6;
        }

        .empty-state-text code {
            font-family: var(--vscode-editor-font-family);
            font-size: 11px;
            background: var(--vscode-textCodeBlock-background);
            padding: 2px 4px;
            color: var(--vscode-textPreformat-foreground);
        }

        .empty-state-text ol {
            list-style-position: inside;
            padding-left: 0;
        }

        .empty-state-text a {
            color: var(--vscode-textLink-foreground);
            text-decoration: none;
        }

        .empty-state-text a:hover {
            color: var(--vscode-textLink-activeForeground);
            text-decoration: underline;
        }

        /* Pagination - Minimal, Inline */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding: 12px;
            border-top: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBar-background);
        }

        .pagination-btn {
            padding: 4px 8px;
            min-width: 28px;
            height: 24px;
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .pagination-info {
            color: var(--vscode-descriptionForeground);
            font-size: 11px;
            margin: 0 8px;
        }

        /* Loading */
        .loading {
            padding: 20px;
            text-align: center;
            color: var(--vscode-descriptionForeground);
            font-size: 12px;
        }

        /* Error */
        .error-message {
            background: var(--vscode-inputValidation-errorBackground);
            color: var(--vscode-inputValidation-errorForeground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            padding: 8px 12px;
            font-size: 12px;
            margin: 8px 12px;
        }

        /* Markdown Content Styling - IDE Integration (Requirements: 16.1, 16.5, 16.7) */
        .markdown-content {
            color: var(--vscode-foreground);
            font-family: var(--vscode-font-family);
            font-size: 13px;
            line-height: 1.6;
            padding: 12px;
        }

        /* Markdown Headings - Compact, IDE-style */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            color: var(--vscode-foreground);
            font-weight: 600;
            margin: 16px 0 8px 0;
            padding: 0;
            line-height: 1.3;
        }

        .markdown-content h1 {
            font-size: 18px;
            border-bottom: 1px solid var(--vscode-panel-border);
            padding-bottom: 8px;
        }

        .markdown-content h2 {
            font-size: 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            padding-bottom: 6px;
        }

        .markdown-content h3 {
            font-size: 14px;
        }

        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-size: 13px;
        }

        /* Markdown Paragraphs - Compact spacing */
        .markdown-content p {
            margin: 8px 0;
        }

        /* Markdown Lists - Compact, IDE-style */
        .markdown-content ul,
        .markdown-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .markdown-content li {
            margin: 4px 0;
        }

        /* Task Lists - GFM extension */
        .markdown-content ul.task-list {
            list-style: none;
            padding-left: 0;
        }

        .markdown-content li.task-list-item {
            margin: 4px 0;
            padding-left: 24px;
        }

        .markdown-content li.task-list-item input[type="checkbox"] {
            margin-right: 8px;
            margin-left: -24px;
        }

        /* Markdown Code - Editor-style backgrounds (Requirements: 16.5, 16.7) */
        .markdown-content code {
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
            background: var(--vscode-textCodeBlock-background);
            color: var(--vscode-textPreformat-foreground);
            padding: 2px 4px;
            border-radius: 0;
        }

        .markdown-content pre {
            background: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-panel-border);
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            border-radius: 0;
        }

        .markdown-content pre code {
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
            background: transparent;
            padding: 0;
            line-height: 1.5;
        }

        /* Markdown Tables - IDE-style (GFM extension) */
        .markdown-content table.markdown-table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
            font-size: 12px;
        }

        .markdown-content table.markdown-table th,
        .markdown-content table.markdown-table td {
            border: 1px solid var(--vscode-panel-border);
            padding: 6px 8px;
            text-align: left;
        }

        .markdown-content table.markdown-table th {
            background: var(--vscode-sideBarSectionHeader-background);
            font-weight: 600;
        }

        .markdown-content table.markdown-table tr:nth-child(even) {
            background: var(--vscode-list-hoverBackground);
        }

        /* Markdown Blockquotes - Subtle, IDE-style */
        .markdown-content blockquote {
            border-left: 4px solid var(--vscode-panel-border);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--vscode-descriptionForeground);
            font-style: italic;
        }

        /* Markdown Links - IDE-style */
        .markdown-content a {
            color: var(--vscode-textLink-foreground);
            text-decoration: none;
        }

        .markdown-content a:hover {
            color: var(--vscode-textLink-activeForeground);
            text-decoration: underline;
        }

        /* Markdown Horizontal Rules - Subtle separator */
        .markdown-content hr {
            border: none;
            border-top: 1px solid var(--vscode-panel-border);
            margin: 16px 0;
        }

        /* Markdown Images - Constrained width */
        .markdown-content img {
            max-width: 100%;
            height: auto;
            margin: 8px 0;
        }

        /* Strikethrough - GFM extension */
        .markdown-content del {
            text-decoration: line-through;
            color: var(--vscode-descriptionForeground);
        }

        /* Mermaid Diagrams - IDE-style */
        .markdown-content .mermaid-diagram {
            margin: 12px 0;
            padding: 12px;
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            overflow-x: auto;
        }

        .markdown-content .mermaid-diagram svg {
            max-width: 100%;
            height: auto;
        }

        /* Syntax Highlighting - Use VSCode editor theme colors */
        .markdown-content .hljs {
            background: var(--vscode-textCodeBlock-background);
            color: var(--vscode-editor-foreground);
        }

        /* Remove website-style decorations */
        .markdown-content * {
            border-radius: 0 !important;  /* No rounded corners */
            box-shadow: none !important;  /* No shadows */
        }

        /* Codicon styling */
        .codicon {
            font-size: 14px;
            vertical-align: middle;
        }

        .filter-btn .codicon,
        .action-btn .codicon,
        .pagination-btn .codicon {
            font-size: 12px;
        }

        /* Profile Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal {
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBarSectionHeader-background);
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .modal-close-btn {
            padding: 4px;
            width: 24px;
            height: 24px;
            background: transparent;
            color: var(--vscode-foreground);
            border: none;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            background: var(--vscode-toolbar-hoverBackground);
        }

        .modal-close-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBar-background);
        }

        .modal-btn {
            padding: 6px 14px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-family: var(--vscode-font-family);
            font-size: 12px;
            outline: none;
        }

        .modal-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .modal-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .modal-btn.secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .modal-btn.secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Profile List */
        .profile-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .profile-list-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .create-profile-btn {
            padding: 4px 12px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .create-profile-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .create-profile-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .profile-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid var(--vscode-panel-border);
            margin-bottom: 8px;
            background: var(--vscode-sideBar-background);
        }

        .profile-item:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .profile-icon {
            font-size: 20px;
            color: var(--vscode-foreground);
        }

        .profile-details {
            flex: 1;
        }

        .profile-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
            margin-bottom: 2px;
        }

        .profile-description {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }

        .profile-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            font-size: 10px;
            font-weight: 600;
            border-radius: 2px;
            margin-left: 8px;
        }

        .profile-actions {
            display: flex;
            gap: 4px;
        }

        .profile-action-btn {
            padding: 4px 8px;
            background: transparent;
            color: var(--vscode-button-foreground);
            border: 1px solid var(--vscode-button-border);
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 11px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .profile-action-btn:hover:not(:disabled) {
            background: var(--vscode-button-hoverBackground);
        }

        .profile-action-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .profile-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Profile Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--vscode-foreground);
            margin-bottom: 6px;
        }

        .form-label .required {
            color: var(--vscode-errorForeground);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 6px 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            font-family: var(--vscode-font-family);
            font-size: 13px;
            outline: none;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: var(--vscode-focusBorder);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }

        .form-textarea {
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
            resize: vertical;
            min-height: 120px;
        }

        .form-help {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-top: 4px;
        }

        .form-error {
            font-size: 11px;
            color: var(--vscode-errorForeground);
            margin-top: 4px;
        }

        .template-variables-doc {
            background: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-panel-border);
            padding: 12px;
            margin-top: 8px;
            font-size: 11px;
        }

        .template-variables-doc h4 {
            font-size: 12px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--vscode-foreground);
        }

        .template-variables-doc ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .template-variables-doc li {
            margin: 4px 0;
            font-family: var(--vscode-editor-font-family);
        }

        .template-variables-doc code {
            background: var(--vscode-editor-background);
            padding: 2px 4px;
            color: var(--vscode-textPreformat-foreground);
        }

        .icon-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .icon-preview-label {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }

        .icon-preview-icon {
            font-size: 24px;
            color: var(--vscode-foreground);
        }

        /* Detail View - Native IDE Style (Requirements: 16.3, 16.4, 16.7, 16.8) */
        .detail-view {
            border-top: 1px solid var(--vscode-panel-border);
            background: var(--vscode-editor-background);
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBarSectionHeader-background);
        }

        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .detail-actions {
            display: flex;
            gap: 4px;
        }

        .detail-nav-btn,
        .detail-close-btn {
            padding: 4px;
            width: 24px;
            height: 24px;
            background: transparent;
            color: var(--vscode-foreground);
            border: none;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .detail-nav-btn:hover,
        .detail-close-btn:hover {
            background: var(--vscode-toolbar-hoverBackground);
        }

        .detail-nav-btn:focus,
        .detail-close-btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .detail-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Detail Tabs - Flat, Minimal (Requirements: 16.3, 16.4) */
        .detail-tabs {
            display: flex;
            background: var(--vscode-sideBar-background);
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .detail-tab {
            padding: 8px 12px;
            background: transparent;
            color: var(--vscode-descriptionForeground);
            border: none;
            border-bottom: 2px solid transparent;
            font-family: var(--vscode-font-family);
            font-size: 12px;
            cursor: pointer;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .detail-tab:hover {
            background: var(--vscode-list-hoverBackground);
            color: var(--vscode-foreground);
        }

        .detail-tab.active {
            color: var(--vscode-foreground);
            border-bottom-color: var(--vscode-focusBorder);
        }

        .detail-tab:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        /* Detail Content - Editor-style background */
        .detail-content {
            background: var(--vscode-editor-background);
            max-height: 600px;
            overflow-y: auto;
        }

        .detail-tab-content {
            display: none;
            padding: 12px;
        }

        .detail-tab-content.active {
            display: block;
        }

        .detail-tab-content .markdown-content {
            padding: 0;
        }

        /* Empty detail content message */
        .detail-empty {
            padding: 20px;
            text-align: center;
            color: var(--vscode-descriptionForeground);
            font-size: 12px;
        }

        /* Execution History Styles */
        .history-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid var(--vscode-panel-border);
            margin-bottom: 8px;
            background: var(--vscode-sideBar-background);
            cursor: pointer;
        }

        .history-item:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .history-item-main {
            flex: 1;
        }

        .history-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .history-spec-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .history-profile-name {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }

        .history-item-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            font-family: var(--vscode-editor-font-family);
        }

        .history-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 600;
        }

        .history-status-badge.running {
            background: var(--vscode-statusBarItem-warningBackground);
            color: var(--vscode-statusBarItem-warningForeground);
        }

        .history-status-badge.completed {
            background: var(--vscode-testing-iconPassed);
            color: var(--vscode-button-foreground);
        }

        .history-status-badge.failed {
            background: var(--vscode-statusBarItem-errorBackground);
            color: var(--vscode-statusBarItem-errorForeground);
        }

        .history-status-badge.cancelled {
            background: var(--vscode-descriptionForeground);
            color: var(--vscode-button-foreground);
        }

        .history-detail-header {
            margin-bottom: 16px;
        }

        .history-detail-content {
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            padding: 16px;
        }

        .history-detail-section {
            margin-bottom: 16px;
        }

        .history-detail-section:last-child {
            margin-bottom: 0;
        }

        .history-detail-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--vscode-descriptionForeground);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .history-detail-value {
            font-size: 13px;
            color: var(--vscode-foreground);
            font-family: var(--vscode-editor-font-family);
        }

        .history-detail-error {
            background: var(--vscode-inputValidation-errorBackground);
            color: var(--vscode-inputValidation-errorForeground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            padding: 8px 12px;
            font-size: 12px;
            margin-top: 8px;
            font-family: var(--vscode-editor-font-family);
        }

        /* Execution Statistics Styles */
        .history-statistics {
            background: var(--vscode-sideBarSectionHeader-background);
            border: 1px solid var(--vscode-panel-border);
            padding: 16px;
            margin-bottom: 16px;
        }

        .statistics-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
            margin-bottom: 12px;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--vscode-sideBar-background);
            border: 1px solid var(--vscode-panel-border);
            padding: 12px;
        }

        .stat-card-label {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-bottom: 4px;
        }

        .stat-card-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--vscode-foreground);
            font-family: var(--vscode-editor-font-family);
        }

        .stat-card-unit {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-left: 4px;
        }

        .statistics-section {
            margin-bottom: 16px;
        }

        .statistics-section:last-child {
            margin-bottom: 0;
        }

        .statistics-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--vscode-foreground);
            margin-bottom: 8px;
        }

        .statistics-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .statistics-table th,
        .statistics-table td {
            padding: 6px 8px;
            text-align: left;
            border: 1px solid var(--vscode-panel-border);
        }

        .statistics-table th {
            background: var(--vscode-sideBarSectionHeader-background);
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .statistics-table td {
            color: var(--vscode-foreground);
            font-family: var(--vscode-editor-font-family);
        }

        .statistics-table tr:hover {
            background: var(--vscode-list-hoverBackground);
        }

    </style>
</head>
<body>
    <div class="container">
        <div id="errorContainer"></div>
        <div id="loadingContainer"></div>

        <div id="statsContainer" style="display: none;">
            <!-- Statistics Header - Compact, Inline -->
            <div class="stats-header">
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-value" id="totalSpecs">0</span>
                        <span>specs</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="completedTasks">0</span>
                        <span>done</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="pendingTasks">0</span>
                        <span>todo</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="overallPercentage">0%</span>
                        <span>total</span>
                    </div>
                </div>
                <div class="button-row">
                    <button class="analytics-button" id="analyticsBtn">
                        <span class="codicon codicon-graph"></span>
                        Metrics
                    </button>
                    <button class="analytics-button" id="manageProfilesBtn">
                        <span class="codicon codicon-settings-gear"></span>
                        Profiles
                    </button>
                    <!-- HIDDEN: Simplified UI - execution history feature hidden for now -->
                    <!-- <button class="analytics-button" id="executionHistoryBtn">
                        <span class="codicon codicon-history"></span>
                        History
                    </button> -->
                </div>
            </div>

            <!-- Filter Controls - Native Input Styling -->
            <div class="filter-controls">
                <input type="text" id="search" class="search-input" placeholder="Filter by name...">
                
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">
                        <span class="codicon codicon-list-unordered"></span> All
                    </button>
                    <button class="filter-btn" data-filter="in-progress">
                        <span class="codicon codicon-sync"></span> Active
                    </button>
                    <button class="filter-btn" data-filter="completed">
                        <span class="codicon codicon-check"></span> Done
                    </button>
                    <button class="filter-btn" data-filter="pending">
                        <span class="codicon codicon-circle-outline"></span> Todo
                    </button>
                </div>
                
                <div class="items-per-page">
                    <span>Items per page:</span>
                    <select id="itemsPerPage">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="all">All</option>
                    </select>
                </div>
            </div>

            <!-- Spec List - Flat, List-Based Layout -->
            <ul class="spec-list" id="specList"></ul>
            
            <!-- Detail View - Inline Expansion (Native IDE Style) -->
            <div id="detailView" class="detail-view" style="display: none;">
                <div class="detail-header">
                    <div class="detail-title" id="detailTitle"></div>
                    <div class="detail-actions">
                        <button class="detail-nav-btn" id="detailPrevBtn" title="Previous spec">
                            <span class="codicon codicon-chevron-left"></span>
                        </button>
                        <button class="detail-nav-btn" id="detailNextBtn" title="Next spec">
                            <span class="codicon codicon-chevron-right"></span>
                        </button>
                        <button class="detail-close-btn" id="detailCloseBtn" title="Close detail view">
                            <span class="codicon codicon-close"></span>
                        </button>
                    </div>
                </div>
                
                <div class="detail-tabs">
                    <button class="detail-tab active" data-tab="requirements">
                        <span class="codicon codicon-file"></span> Requirements
                    </button>
                    <button class="detail-tab" data-tab="design">
                        <span class="codicon codicon-edit"></span> Design
                    </button>
                    <button class="detail-tab" data-tab="tasks">
                        <span class="codicon codicon-list-unordered"></span> Tasks
                    </button>
                </div>
                
                <div class="detail-content">
                    <div class="detail-tab-content active" id="detailRequirements">
                        <div class="markdown-content"></div>
                    </div>
                    <div class="detail-tab-content" id="detailDesign">
                        <div class="markdown-content"></div>
                    </div>
                    <div class="detail-tab-content" id="detailTasks">
                        <div class="markdown-content"></div>
                    </div>
                </div>
            </div>
            
            <!-- Pagination -->
            <div id="paginationContainer"></div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileSettingsModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Manage Execution Profiles</div>
                <button class="modal-close-btn" id="closeProfileSettingsBtn">
                    <span class="codicon codicon-close"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="profile-list-header">
                    <div class="profile-list-title">Execution Profiles</div>
                    <button class="create-profile-btn" id="createProfileBtn">
                        <span class="codicon codicon-add"></span>
                        Create New Profile
                    </button>
                </div>
                <ul class="profile-list" id="profileList">
                    <!-- Profile items will be inserted here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Profile Form Modal -->
    <div id="profileFormModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="profileFormTitle">Create Profile</div>
                <button class="modal-close-btn" id="closeProfileFormBtn">
                    <span class="codicon codicon-close"></span>
                </button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label" for="profileName">
                            Name <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="profileName" 
                            class="form-input" 
                            placeholder="e.g., Quick MVP, Full Implementation"
                            required
                        />
                        <div class="form-help">A descriptive name for this execution profile</div>
                        <div class="form-error" id="profileNameError" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileIcon">
                            Icon <span class="required">*</span>
                        </label>
                        <select id="profileIcon" class="form-select" required>
                            <option value="rocket">ðŸš€ Rocket</option>
                            <option value="checklist">âœ“ Checklist</option>
                            <option value="star">â­ Star</option>
                            <option value="zap">âš¡ Zap</option>
                            <option value="gear">âš™ï¸ Gear</option>
                            <option value="beaker">ðŸ§ª Beaker</option>
                            <option value="flame">ðŸ”¥ Flame</option>
                            <option value="target">ðŸŽ¯ Target</option>
                            <option value="play">â–¶ï¸ Play</option>
                            <option value="debug">ðŸ› Debug</option>
                        </select>
                        <div class="icon-preview">
                            <span class="icon-preview-label">Preview:</span>
                            <span class="codicon codicon-rocket icon-preview-icon" id="iconPreview"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileDescription">
                            Description
                        </label>
                        <input 
                            type="text" 
                            id="profileDescription" 
                            class="form-input" 
                            placeholder="Optional description"
                        />
                        <div class="form-help">Optional description to help identify this profile</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileTemplate">
                            Prompt Template <span class="required">*</span>
                        </label>
                        <textarea 
                            id="profileTemplate" 
                            class="form-textarea" 
                            placeholder="Enter your prompt template with variables..."
                            required
                        ></textarea>
                        <div class="form-help">The prompt that will be sent to Kiro when executing specs</div>
                        <div class="form-error" id="profileTemplateError" style="display: none;"></div>
                        
                        <div class="template-variables-doc">
                            <h4>Available Template Variables</h4>
                            <ul>
                                <li><code>{{specName}}</code> - Name of the spec</li>
                                <li><code>{{specPath}}</code> - Absolute path to spec folder</li>
                                <li><code>{{totalTasks}}</code> - Total number of tasks</li>
                                <li><code>{{completedTasks}}</code> - Number of completed tasks</li>
                                <li><code>{{remainingTasks}}</code> - Number of remaining tasks</li>
                                <li><code>{{workspaceFolder}}</code> - Workspace folder name</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancelProfileFormBtn">Cancel</button>
                <button class="modal-btn" id="saveProfileBtn">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Execution History Modal -->
    <div id="executionHistoryModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Execution History</div>
                <button class="modal-close-btn" id="closeExecutionHistoryBtn">
                    <span class="codicon codicon-close"></span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Statistics Summary -->
                <div id="historyStatistics" class="history-statistics" style="display: none;">
                    <div class="statistics-title">Execution Statistics</div>
                    
                    <!-- Overall Statistics -->
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <div class="stat-card-label">Total Executions</div>
                            <div class="stat-card-value" id="statTotalExecutions">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-label">Success Rate</div>
                            <div class="stat-card-value">
                                <span id="statSuccessRate">0</span><span class="stat-card-unit">%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-label">Avg Duration</div>
                            <div class="stat-card-value" id="statAvgDuration">0s</div>
                        </div>
                    </div>

                    <!-- Per-Spec Statistics -->
                    <div class="statistics-section" id="perSpecStatsSection" style="display: none;">
                        <div class="statistics-section-title">By Spec</div>
                        <table class="statistics-table">
                            <thead>
                                <tr>
                                    <th>Spec</th>
                                    <th>Executions</th>
                                    <th>Success</th>
                                    <th>Failed</th>
                                    <th>Avg Duration</th>
                                </tr>
                            </thead>
                            <tbody id="perSpecStatsBody">
                            </tbody>
                        </table>
                    </div>

                    <!-- Per-Profile Statistics -->
                    <div class="statistics-section" id="perProfileStatsSection" style="display: none;">
                        <div class="statistics-section-title">By Profile</div>
                        <table class="statistics-table">
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Executions</th>
                                    <th>Success</th>
                                    <th>Failed</th>
                                    <th>Avg Duration</th>
                                </tr>
                            </thead>
                            <tbody id="perProfileStatsBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="history-filters">
                    <div class="form-group">
                        <label class="form-label">Filter by Spec</label>
                        <select id="historySpecFilter" class="form-select">
                            <option value="">All Specs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Profile</label>
                        <select id="historyProfileFilter" class="form-select">
                            <option value="">All Profiles</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Status</label>
                        <select id="historyStatusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="running">Running</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <!-- History List View -->
                <div id="historyListView">
                    <ul class="history-list" id="historyList">
                        <!-- History entries will be inserted here -->
                    </ul>
                    <div id="historyEmptyState" class="empty-state" style="display: none;">
                        <div class="empty-state-text">No execution history found.</div>
                    </div>
                </div>

                <!-- History Detail View -->
                <div id="historyDetailView" style="display: none;">
                    <div class="history-detail-header">
                        <button class="modal-btn secondary" id="backToHistoryListBtn">
                            <span class="codicon codicon-arrow-left"></span>
                            Back to List
                        </button>
                    </div>
                    <div class="history-detail-content" id="historyDetailContent">
                        <!-- Detail content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script nonce="{{nonce}}">
        // Global error handler for catching JavaScript errors (Requirement 11.3)
        window.addEventListener('error', function(event) {
            console.error('Webview error:', event.error);
            
            // Report error to extension
            try {
                vscode.postMessage({
                    type: 'webviewError',
                    error: {
                        message: event.error?.message || event.message || 'Unknown error',
                        stack: event.error?.stack || '',
                        filename: event.filename || '',
                        lineno: event.lineno || 0,
                        colno: event.colno || 0
                    }
                });
            } catch (e) {
                console.error('Failed to report error to extension:', e);
            }
            
            // Show fallback UI
            showFallbackUI('An error occurred while rendering the dashboard. Please refresh.');
            
            // Prevent default error handling
            event.preventDefault();
        });
        
        // Global promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            
            // Report error to extension
            try {
                vscode.postMessage({
                    type: 'webviewError',
                    error: {
                        message: event.reason?.message || String(event.reason) || 'Promise rejection',
                        stack: event.reason?.stack || ''
                    }
                });
            } catch (e) {
                console.error('Failed to report promise rejection to extension:', e);
            }
            
            // Show fallback UI
            showFallbackUI('An error occurred while processing data. Please refresh.');
            
            // Prevent default handling
            event.preventDefault();
        });
        
        // Show fallback UI when errors occur (Requirement 11.3)
        function showFallbackUI(message) {
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="color: var(--vscode-errorForeground); font-size: 16px; margin-bottom: 12px;">
                            âš  Dashboard Error
                        </div>
                        <div style="color: var(--vscode-foreground); margin-bottom: 16px;">
                            ${escapeHtml(message)}
                        </div>
                        <button id="reloadButton" style="
                            padding: 6px 12px;
                            background: var(--vscode-button-background);
                            color: var(--vscode-button-foreground);
                            border: none;
                            cursor: pointer;
                            font-family: var(--vscode-font-family);
                            font-size: 13px;
                        ">
                            Refresh Dashboard
                        </button>
                    </div>
                `;
                
                // Add event listener to the reload button
                const reloadButton = document.getElementById('reloadButton');
                if (reloadButton) {
                    reloadButton.addEventListener('click', () => {
                        location.reload();
                    });
                }
            }
        }
        
        // Acquire VS Code API
        const vscode = acquireVsCodeApi();
        
        // Dashboard state
        let currentState = {
            filterMode: 'all',
            searchQuery: '',
            currentPage: 1,
            itemsPerPage: 10,
            sortBy: 'name',
            sortOrder: 'asc'
        };
        
        let allSpecs = [];
        let filteredSpecs = [];
        let executionProfiles = [];
        let executionStates = {};
        
        // Request initial data
        vscode.postMessage({ type: 'requestSpecs' });
        vscode.postMessage({ type: 'getProfiles' });
        
        // Show loading state
        showLoading('Loading specs...');
        
        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.type) {
                case 'specsLoaded':
                    allSpecs = message.specs;
                    // Restore state from saved preferences
                    if (message.state) {
                        currentState = { ...currentState, ...message.state };
                    }
                    hideLoading();
                    displaySpecs(allSpecs);
                    break;
                case 'profilesUpdated':
                    executionProfiles = message.profiles || [];
                    // Refresh display if specs are already loaded
                    if (allSpecs.length > 0) {
                        displayPage(currentState.currentPage);
                    }
                    break;
                case 'executionStateChanged':
                    // Update execution state for a specific spec
                    if (message.specId && message.state) {
                        executionStates[message.specId] = message.state;
                        // Refresh the display to show updated status
                        displayPage(currentState.currentPage);
                    }
                    break;
                case 'executionHistoryUpdated':
                    // Update execution history
                    if (message.entries) {
                        renderExecutionHistory(message.entries);
                    }
                    break;
                case 'executionStatisticsUpdated':
                    // Update execution statistics
                    if (message.statistics) {
                        renderExecutionStatistics(message.statistics);
                    }
                    break;
                case 'notesUpdated':
                    // Update notes for a specific spec without resetting dashboard state
                    if (message.specName && currentState.notes) {
                        currentState.notes[message.specName] = message.notes;
                        // Save the updated state
                        saveState();
                    }
                    break;
                case 'error':
                    hideLoading();
                    showError(message.message);
                    break;
            }
        });
        
        // Save state to extension
        function saveState() {
            vscode.postMessage({ 
                type: 'saveState', 
                state: currentState 
            });
        }
        
        // Display specs on the dashboard
        function displaySpecs(specs) {
            try {
                const statsContainer = document.getElementById('statsContainer');
                const specList = document.getElementById('specList');

                filteredSpecs = specs;
                currentState.currentPage = 1;

                if (specs.length === 0) {
                    specList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-title">No Specs Found</div>
                            <div class="empty-state-text">
                                <p>To get started with spec-driven development:</p>
                                <ol style="text-align: left; display: inline-block; margin: 12px 0;">
                                    <li style="margin: 8px 0;">Create a <code>.kiro/specs/</code> directory in your workspace</li>
                                    <li style="margin: 8px 0;">Add a subdirectory for your feature (e.g., <code>user-authentication/</code>)</li>
                                    <li style="margin: 8px 0;">Create a <code>tasks.md</code> file with your task list</li>
                                    <li style="margin: 8px 0;">Optionally add <code>requirements.md</code> and <code>design.md</code></li>
                                </ol>
                                <p style="margin-top: 12px;">
                                    <a href="https://github.com/kiro-ai/kiro" 
                                       target="_blank" 
                                       rel="noopener noreferrer"
                                       style="color: var(--vscode-textLink-foreground); text-decoration: none;">
                                        Learn more about Kiro specs â†’
                                    </a>
                                </p>
                            </div>
                        </div>
                    `;
                    statsContainer.style.display = 'block';
                    return;
                }

                // Calculate overall stats
                const overall = {
                    totalSpecs: specs.length,
                    totalTasks: 0,
                    completedTasks: 0,
                    pendingTasks: 0,
                    optionalTasks: 0
                };

                specs.forEach(spec => {
                    overall.totalTasks += spec.totalTasks;
                    overall.completedTasks += spec.completedTasks;
                    overall.pendingTasks += (spec.totalTasks - spec.completedTasks);
                    overall.optionalTasks += spec.optionalTasks || 0;
                });

                overall.percentage = overall.totalTasks > 0 
                    ? Math.round((overall.completedTasks / overall.totalTasks) * 100) 
                    : 0;

                // Update overall stats
                document.getElementById('totalSpecs').textContent = overall.totalSpecs;
                document.getElementById('completedTasks').textContent = overall.completedTasks;
                document.getElementById('pendingTasks').textContent = overall.pendingTasks;
                document.getElementById('overallPercentage').textContent = overall.percentage + '%';

                statsContainer.style.display = 'block';

                // Setup filters
                setupFilters();

                // Display first page
                displayPage(1);
            } catch (error) {
                console.error('Error in displaySpecs:', error);
                showError('Failed to display specs: ' + (error.message || String(error)));
                
                // Report error to extension
                vscode.postMessage({
                    type: 'webviewError',
                    error: {
                        message: 'displaySpecs failed: ' + (error.message || String(error)),
                        stack: error.stack || ''
                    }
                });
            }
        }
        
        // Setup filter event listeners
        function setupFilters() {
            const searchInput = document.getElementById('search');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            
            // Restore filter values from state
            searchInput.value = currentState.searchQuery;
            itemsPerPageSelect.value = currentState.itemsPerPage;
            
            // Update active filter button
            filterButtons.forEach(btn => {
                if (btn.getAttribute('data-filter') === currentState.filterMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            searchInput.addEventListener('input', (e) => {
                currentState.searchQuery = e.target.value;
                currentState.currentPage = 1;
                saveState();
                applyFilters();
            });
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentState.filterMode = btn.getAttribute('data-filter');
                    currentState.currentPage = 1;
                    saveState();
                    applyFilters();
                });
            });
            
            // Analytics button click handler
            const analyticsBtn = document.getElementById('analyticsBtn');
            if (analyticsBtn) {
                analyticsBtn.addEventListener('click', () => {
                    vscode.postMessage({ type: 'openAnalytics' });
                });
            }
            
            // Manage Profiles button click handler
            const manageProfilesBtn = document.getElementById('manageProfilesBtn');
            if (manageProfilesBtn) {
                manageProfilesBtn.addEventListener('click', () => {
                    vscode.postMessage({ type: 'openProfiles' });
                });
            }
            
            itemsPerPageSelect.addEventListener('change', (e) => {
                currentState.itemsPerPage = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
                currentState.currentPage = 1;
                saveState();
                displayPage(1);
            });
        }
        
        // Apply filters to specs
        function applyFilters() {
            filteredSpecs = allSpecs.filter(spec => {
                // Apply status filter
                if (currentState.filterMode === 'in-progress' && (spec.progress === 0 || spec.progress === 100)) {
                    return false;
                }
                if (currentState.filterMode === 'completed' && spec.progress !== 100) {
                    return false;
                }
                if (currentState.filterMode === 'pending' && spec.progress !== 0) {
                    return false;
                }
                
                // Apply search query
                if (currentState.searchQuery) {
                    const query = currentState.searchQuery.toLowerCase();
                    const displayName = formatDisplayName(spec.name).toLowerCase();
                    return displayName.includes(query) || spec.name.toLowerCase().includes(query);
                }
                
                return true;
            });
            
            displayPage(1);
        }
        
        // Display a specific page of specs
        function displayPage(page) {
            currentState.currentPage = page;
            const specList = document.getElementById('specList');
            const paginationContainer = document.getElementById('paginationContainer');
            
            let pageSpecs;
            let listHTML = '';
            
            if (currentState.itemsPerPage === 'all') {
                // Show all specs without pagination
                pageSpecs = filteredSpecs;
                listHTML = pageSpecs.map(spec => createSpecListItem(spec)).join('');
                paginationContainer.innerHTML = '';
            } else {
                // Show paginated specs
                const startIndex = (page - 1) * currentState.itemsPerPage;
                const endIndex = startIndex + currentState.itemsPerPage;
                pageSpecs = filteredSpecs.slice(startIndex, endIndex);
                
                listHTML = pageSpecs.map(spec => createSpecListItem(spec)).join('');
                
                // Add pagination controls
                const totalPages = Math.ceil(filteredSpecs.length / currentState.itemsPerPage);
                if (totalPages > 1) {
                    paginationContainer.innerHTML = createPaginationControls(page, totalPages);
                } else {
                    paginationContainer.innerHTML = '';
                }
            }

            specList.innerHTML = listHTML;
            
            // Add event listeners to file open buttons
            attachFileOpenListeners();
            
            // Add event listeners to pagination buttons
            attachPaginationListeners();
        }
        
        // Create a spec list item HTML
        function createSpecListItem(spec) {
            const displayName = formatDisplayName(spec.name);
            const progress = spec.progress || 0;
            const totalTasks = spec.totalTasks || 0;
            const completedTasks = spec.completedTasks || 0;
            const pendingTasks = totalTasks - completedTasks;
            const optionalTasks = spec.optionalTasks || 0;
            
            let statusBadge = '';
            if (progress === 100) {
                statusBadge = '<span class="spec-badge">DONE</span>';
            } else if (progress > 0) {
                statusBadge = '<span class="spec-badge">ACTIVE</span>';
            } else {
                statusBadge = '<span class="spec-badge">TODO</span>';
            }

            // Add workspace folder indicator for multi-root workspaces
            const workspaceFolderIndicator = spec.workspaceFolder 
                ? `<span class="workspace-folder">[${escapeHtml(spec.workspaceFolder)}]</span> ` 
                : '';
            
            // Show relative path from workspace root
            const relativePath = `.kiro/specs/${spec.name}`;

            // Show workspace folder in brackets for multi-root workspaces
            const workspaceFolderDisplay = spec.workspaceFolder 
                ? `<span class="workspace-folder">[${escapeHtml(spec.workspaceFolder)}]</span>`
                : '';

            // Always show execution button with profile dropdown (no status display)
            const executionControlsHTML = `
                <div class="execution-controls">
                    <div class="execution-btn-wrapper">
                        <button class="execution-btn" data-spec-id="${escapeHtml(spec.name)}" title="Execute spec with profile">
                            <span class="codicon codicon-play"></span>
                            Execute
                            <span class="codicon codicon-chevron-down"></span>
                        </button>
                    </div>
                </div>
            `;

            return `
                <li class="spec-item">
                    <div class="spec-item-header">
                        <div class="spec-name">${escapeHtml(displayName)}</div>
                        ${statusBadge}
                    </div>
                    <div class="spec-path">${workspaceFolderDisplay}</div>
                    <div class="spec-progress-bar">
                        <div class="spec-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="spec-stats">
                        <div class="spec-stat">
                            <span>${progress}%</span>
                        </div>
                        <div class="spec-stat">
                            <span>${completedTasks}/${totalTasks} tasks</span>
                        </div>
                        ${optionalTasks > 0 ? `<div class="spec-stat"><span>${optionalTasks} optional</span></div>` : ''}
                    </div>
                    ${executionControlsHTML}
                    <div class="spec-actions">
                        <button class="action-btn" data-spec="${escapeHtml(spec.name)}" data-file="requirements.md" title="Open requirements.md">
                            <span class="codicon codicon-file"></span> Requirements
                        </button>
                        <button class="action-btn" data-spec="${escapeHtml(spec.name)}" data-file="design.md" title="Open design.md">
                            <span class="codicon codicon-edit"></span> Design
                        </button>
                        <button class="action-btn" data-spec="${escapeHtml(spec.name)}" data-file="tasks.md" title="Open tasks.md">
                            <span class="codicon codicon-list-unordered"></span> Tasks
                        </button>
                        <button class="action-btn" data-spec="${escapeHtml(spec.name)}" data-action="notes" title="View notes">
                            <span class="codicon codicon-note"></span> Notes
                        </button>
                    </div>
                </li>
            `;
        }
        
        // Create a spec card HTML (legacy - kept for compatibility)
        function createSpecCard(spec) {
            return createSpecListItem(spec);
        }
        
        // Create pagination controls HTML
        function createPaginationControls(currentPage, totalPages) {
            const startItem = (currentPage - 1) * currentState.itemsPerPage + 1;
            const endItem = Math.min(currentPage * currentState.itemsPerPage, filteredSpecs.length);
            
            let paginationHTML = '<div class="pagination">';
            
            // Previous button
            paginationHTML += `<button class="pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>
                <span class="codicon codicon-chevron-left"></span> Prev
            </button>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<span class="pagination-info">...</span>';
                }
            }
            
            // Next button
            paginationHTML += `<button class="pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>
                Next <span class="codicon codicon-chevron-right"></span>
            </button>`;
            
            // Info
            paginationHTML += `<span class="pagination-info">Showing ${startItem}-${endItem} of ${filteredSpecs.length}</span>`;
            
            paginationHTML += '</div>';
            return paginationHTML;
        }
        
        // Change to a specific page
        function changePage(page) {
            displayPage(page);
            saveState();
        }
        
        // View spec details (placeholder for task 12)
        function viewSpecDetails(specName) {
            vscode.postMessage({
                type: 'viewDetails',
                specName: specName
            });
        }
        
        // Open a specific spec file in the editor
        function openSpecFile(specName, fileName) {
            console.log('openSpecFile called:', specName, fileName);
            console.log('All specs:', allSpecs);
            
            // Find the spec to get its path
            const spec = allSpecs.find(s => s.name === specName);
            console.log('Found spec:', spec);
            
            if (!spec) {
                showError(`Spec not found: ${specName}`);
                return;
            }
            
            if (!spec.path) {
                showError(`Spec path is missing for: ${specName}`);
                console.error('Spec object:', JSON.stringify(spec, null, 2));
                return;
            }
            
            // Construct the full file path
            const filePath = `${spec.path}/${fileName}`;
            console.log('Opening file:', filePath);
            console.log('File path components - spec.path:', spec.path, 'fileName:', fileName);
            
            // Send message to extension to open the file
            vscode.postMessage({
                type: 'openFile',
                filePath: filePath
            });
        }
        
        // Attach event listeners to file open buttons
        function attachFileOpenListeners() {
            const buttons = document.querySelectorAll('.action-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const specName = this.getAttribute('data-spec');
                    const fileName = this.getAttribute('data-file');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'notes') {
                        // Open notes in main editor area via command
                        vscode.postMessage({
                            type: 'openNotes',
                            specName: specName
                        });
                    } else if (specName && fileName) {
                        openSpecFile(specName, fileName);
                    }
                });
            });

            // Attach execution button listeners
            const executionButtons = document.querySelectorAll('.execution-btn');
            executionButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const specId = this.getAttribute('data-spec-id');
                    showProfileDropdown(this, specId);
                });
            });

            // Attach cancel button listeners
            const cancelButtons = document.querySelectorAll('.cancel-btn');
            cancelButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const executionId = this.getAttribute('data-execution-id');
                    cancelExecution(executionId);
                });
            });
        }
        
        // Show profile dropdown for execution
        function showProfileDropdown(button, specId) {
            // Close any existing dropdowns
            closeAllDropdowns();

            if (executionProfiles.length === 0) {
                showError('No execution profiles available. Please create a profile first.');
                return;
            }

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'execution-dropdown';
            dropdown.id = 'profile-dropdown';

            // Populate with profiles
            executionProfiles.forEach(profile => {
                const item = document.createElement('div');
                item.className = 'execution-dropdown-item';
                item.innerHTML = `
                    <span class="codicon codicon-${escapeHtml(profile.icon || 'rocket')}"></span>
                    <span>${escapeHtml(profile.name)}</span>
                `;
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    executeSpec(specId, profile.id);
                    closeAllDropdowns();
                });
                dropdown.appendChild(item);
            });

            // Position and show dropdown
            const wrapper = button.parentElement;
            wrapper.appendChild(dropdown);

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeAllDropdowns, { once: true });
            }, 0);
        }

        // Close all dropdowns
        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.execution-dropdown');
            dropdowns.forEach(dropdown => dropdown.remove());
        }

        // Execute a spec with a profile
        function executeSpec(specId, profileId) {
            console.log('Executing spec:', specId, 'with profile:', profileId);
            
            vscode.postMessage({
                type: 'executeSpec',
                specId: specId,
                profileId: profileId
            });
        }

        // Cancel an execution
        function cancelExecution(executionId) {
            console.log('Cancelling execution:', executionId);
            
            vscode.postMessage({
                type: 'cancelExecution',
                executionId: executionId
            });
        }
        
        // Attach event listeners to pagination buttons
        function attachPaginationListeners() {
            const paginationButtons = document.querySelectorAll('.pagination-btn');
            paginationButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (!this.disabled) {
                        const page = parseInt(this.getAttribute('data-page'));
                        if (page) {
                            changePage(page);
                        }
                    }
                });
            });
        }
        
        // Show detail view with specific tab
        function showDetailView(specName, tabName = 'requirements') {
            const spec = allSpecs.find(s => s.name === specName);
            if (!spec) return;
            
            const detailView = document.getElementById('detailView');
            const detailTitle = document.getElementById('detailTitle');
            
            detailTitle.textContent = formatDisplayName(specName);
            detailView.style.display = 'block';
            
            // Switch to the specified tab
            const tabs = document.querySelectorAll('.detail-tab');
            const contents = document.querySelectorAll('.detail-tab-content');
            
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            contents.forEach(content => {
                if (content.id === `detail${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        // Format display name from kebab-case
        function formatDisplayName(name) {
            return name.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        /**
         * Escape HTML special characters to prevent XSS attacks
         * This function converts special HTML characters to their entity equivalents
         * 
         * @param {string} text - Text to escape
         * @returns {string} Escaped text safe for HTML insertion
         * 
         * Requirements: 10.5
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        /**
         * Sanitize HTML content by removing potentially dangerous elements and attributes
         * This provides defense-in-depth for markdown-rendered content
         * 
         * Allowed elements: p, br, strong, em, code, pre, ul, ol, li, a, h1-h6, table, thead, tbody, tr, th, td, blockquote, hr, img, div, span
         * Allowed attributes: href (for a), src/alt (for img), class, id
         * 
         * @param {string} html - HTML content to sanitize
         * @returns {string} Sanitized HTML
         * 
         * Requirements: 10.5
         */
        function sanitizeHtml(html) {
            if (!html || typeof html !== 'string') {
                return '';
            }
            
            // Create a temporary DOM element to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Allowed tags and attributes
            const allowedTags = new Set([
                'p', 'br', 'strong', 'em', 'b', 'i', 'u', 'code', 'pre',
                'ul', 'ol', 'li', 'a', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'table', 'thead', 'tbody', 'tr', 'th', 'td', 'blockquote',
                'hr', 'img', 'div', 'span', 'del', 'ins', 'sup', 'sub'
            ]);
            
            const allowedAttributes = new Set([
                'href', 'src', 'alt', 'title', 'class', 'id', 'width', 'height',
                'type', 'disabled', 'checked', 'start'
            ]);
            
            // Recursively sanitize elements
            function sanitizeElement(element) {
                // Remove script and style elements entirely
                if (element.tagName && (element.tagName.toLowerCase() === 'script' || element.tagName.toLowerCase() === 'style')) {
                    element.remove();
                    return;
                }
                
                // Check if tag is allowed
                if (element.tagName && !allowedTags.has(element.tagName.toLowerCase())) {
                    // Replace with text content
                    const textNode = document.createTextNode(element.textContent || '');
                    element.replaceWith(textNode);
                    return;
                }
                
                // Remove disallowed attributes
                if (element.attributes) {
                    const attributesToRemove = [];
                    for (let i = 0; i < element.attributes.length; i++) {
                        const attr = element.attributes[i];
                        const attrName = attr.name.toLowerCase();
                        
                        // Remove event handlers (on*)
                        if (attrName.startsWith('on')) {
                            attributesToRemove.push(attr.name);
                            continue;
                        }
                        
                        // Remove disallowed attributes
                        if (!allowedAttributes.has(attrName)) {
                            attributesToRemove.push(attr.name);
                            continue;
                        }
                        
                        // Sanitize href and src to prevent javascript: protocol
                        if (attrName === 'href' || attrName === 'src') {
                            const value = attr.value.trim().toLowerCase();
                            if (value.startsWith('javascript:') || value.startsWith('data:') || value.startsWith('vbscript:')) {
                                attributesToRemove.push(attr.name);
                            }
                        }
                    }
                    
                    // Remove flagged attributes
                    attributesToRemove.forEach(attrName => {
                        element.removeAttribute(attrName);
                    });
                }
                
                // Recursively sanitize children
                const children = Array.from(element.childNodes);
                children.forEach(child => {
                    if (child.nodeType === Node.ELEMENT_NODE) {
                        sanitizeElement(child);
                    }
                });
            }
            
            // Sanitize all elements
            const children = Array.from(temp.childNodes);
            children.forEach(child => {
                if (child.nodeType === Node.ELEMENT_NODE) {
                    sanitizeElement(child);
                }
            });
            
            return temp.innerHTML;
        }
        
        // Show error message
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="error-message">âš  ${escapeHtml(message)}</div>
                `;
            }
        }
        
        // Clear error message
        function clearError() {
            const errorContainer = document.getElementById('errorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
        }
        
        // Show loading indicator
        function showLoading(message) {
            clearError();
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.innerHTML = `
                    <div class="loading">${escapeHtml(message)}</div>
                `;
            }
        }
        
        // Hide loading indicator
        function hideLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.innerHTML = '';
            }
        }

        // ============================================================================
        // Profile Settings UI Functions
        // ============================================================================

        let currentEditingProfileId = null;

        /**
         * Show the profile settings modal
         * Requirements: 8.1, 8.6
         */
        function showProfileSettings() {
            const modal = document.getElementById('profileSettingsModal');
            if (modal) {
                modal.style.display = 'flex';
                renderProfileList();
            }
        }

        /**
         * Hide the profile settings modal
         */
        function hideProfileSettings() {
            const modal = document.getElementById('profileSettingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        /**
         * Render the list of profiles in the settings modal
         * Requirements: 8.1
         */
        function renderProfileList() {
            const profileList = document.getElementById('profileList');
            if (!profileList) return;

            if (executionProfiles.length === 0) {
                profileList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-text">No profiles available. Create your first profile to get started.</div>
                    </div>
                `;
                return;
            }

            profileList.innerHTML = executionProfiles.map(profile => {
                const isBuiltIn = profile.isBuiltIn;
                const deleteDisabled = isBuiltIn ? 'disabled' : '';
                const builtInBadge = isBuiltIn ? '<span class="profile-badge">BUILT-IN</span>' : '';
                
                return `
                    <li class="profile-item">
                        <div class="profile-info">
                            <span class="codicon codicon-${escapeHtml(profile.icon || 'rocket')} profile-icon"></span>
                            <div class="profile-details">
                                <div class="profile-name">
                                    ${escapeHtml(profile.name)}
                                    ${builtInBadge}
                                </div>
                                ${profile.description ? `<div class="profile-description">${escapeHtml(profile.description)}</div>` : ''}
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="profile-action-btn" data-profile-id="${escapeHtml(profile.id)}" data-action="edit">
                                <span class="codicon codicon-edit"></span>
                                Edit
                            </button>
                            ${isBuiltIn ? `
                            <button class="profile-action-btn" data-profile-id="${escapeHtml(profile.id)}" data-action="reset" title="Reset to default template">
                                <span class="codicon codicon-discard"></span>
                                Reset
                            </button>
                            ` : ''}
                            <button class="profile-action-btn" data-profile-id="${escapeHtml(profile.id)}" data-action="delete" ${deleteDisabled} title="${isBuiltIn ? 'Built-in profiles cannot be deleted' : 'Delete profile'}">
                                <span class="codicon codicon-trash"></span>
                                Delete
                            </button>
                        </div>
                    </li>
                `;
            }).join('');

            // Attach event listeners to profile action buttons
            attachProfileActionListeners();
        }

        /**
         * Attach event listeners to profile action buttons
         */
        function attachProfileActionListeners() {
            const actionButtons = document.querySelectorAll('.profile-action-btn');
            actionButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const profileId = this.getAttribute('data-profile-id');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'edit') {
                        editProfile(profileId);
                    } else if (action === 'delete') {
                        deleteProfile(profileId);
                    } else if (action === 'reset') {
                        resetBuiltInProfile(profileId);
                    }
                });
            });
        }

        /**
         * Show the profile form modal for creating a new profile
         * Requirements: 8.2
         */
        function showCreateProfileForm() {
            currentEditingProfileId = null;
            const modal = document.getElementById('profileFormModal');
            const title = document.getElementById('profileFormTitle');
            const form = document.getElementById('profileForm');
            
            if (title) title.textContent = 'Create Profile';
            if (form) form.reset();
            
            // Clear any error messages
            clearFormErrors();
            
            if (modal) modal.style.display = 'flex';
        }

        /**
         * Show the profile form modal for editing an existing profile
         * Requirements: 8.4
         */
        function editProfile(profileId) {
            const profile = executionProfiles.find(p => p.id === profileId);
            if (!profile) {
                showError('Profile not found');
                return;
            }

            currentEditingProfileId = profileId;
            const modal = document.getElementById('profileFormModal');
            const title = document.getElementById('profileFormTitle');
            const form = document.getElementById('profileForm');
            
            if (title) title.textContent = 'Edit Profile';
            
            // Pre-fill form with profile data
            const nameInput = document.getElementById('profileName');
            const iconSelect = document.getElementById('profileIcon');
            const descriptionInput = document.getElementById('profileDescription');
            const templateTextarea = document.getElementById('profileTemplate');
            
            if (nameInput) nameInput.value = profile.name;
            if (iconSelect) iconSelect.value = profile.icon || 'rocket';
            if (descriptionInput) descriptionInput.value = profile.description || '';
            if (templateTextarea) templateTextarea.value = profile.promptTemplate;
            
            // Update icon preview
            updateIconPreview(profile.icon || 'rocket');
            
            // Clear any error messages
            clearFormErrors();
            
            if (modal) modal.style.display = 'flex';
        }

        /**
         * Delete a profile
         * Requirements: 8.6
         */
        function deleteProfile(profileId) {
            const profile = executionProfiles.find(p => p.id === profileId);
            if (!profile) {
                showError('Profile not found');
                return;
            }

            // Prevent deletion of built-in profiles
            if (profile.isBuiltIn) {
                showError('Built-in profiles cannot be deleted');
                return;
            }

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete the profile "${profile.name}"?`)) {
                return;
            }

            // Send delete message to extension
            vscode.postMessage({
                type: 'deleteProfile',
                profileId: profileId
            });
        }

        /**
         * Reset a built-in profile to its default template
         * Requirements: 3.5
         */
        function resetBuiltInProfile(profileId) {
            const profile = executionProfiles.find(p => p.id === profileId);
            if (!profile) {
                showError('Profile not found');
                return;
            }

            // Only allow resetting built-in profiles
            if (!profile.isBuiltIn) {
                showError('Only built-in profiles can be reset');
                return;
            }

            // Confirm reset
            if (!confirm(`Are you sure you want to reset "${profile.name}" to its default template? Any customizations will be lost.`)) {
                return;
            }

            // Send reset message to extension
            vscode.postMessage({
                type: 'resetBuiltInProfile',
                profileId: profileId
            });
        }

        /**
         * Hide the profile form modal
         */
        function hideProfileForm() {
            const modal = document.getElementById('profileFormModal');
            if (modal) modal.style.display = 'none';
            currentEditingProfileId = null;
        }

        /**
         * Validate the profile form
         * Requirements: 8.2
         */
        function validateProfileForm() {
            let isValid = true;
            clearFormErrors();

            const nameInput = document.getElementById('profileName');
            const templateTextarea = document.getElementById('profileTemplate');

            // Validate name
            if (!nameInput || !nameInput.value.trim()) {
                showFormError('profileNameError', 'Profile name is required');
                isValid = false;
            }

            // Validate template
            if (!templateTextarea || !templateTextarea.value.trim()) {
                showFormError('profileTemplateError', 'Prompt template is required');
                isValid = false;
            }

            return isValid;
        }

        /**
         * Show a form validation error
         */
        function showFormError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        /**
         * Clear all form validation errors
         */
        function clearFormErrors() {
            const errorElements = document.querySelectorAll('.form-error');
            errorElements.forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }

        /**
         * Save the profile (create or update)
         * Requirements: 8.2, 8.4
         */
        function saveProfile() {
            if (!validateProfileForm()) {
                return;
            }

            const nameInput = document.getElementById('profileName');
            const iconSelect = document.getElementById('profileIcon');
            const descriptionInput = document.getElementById('profileDescription');
            const templateTextarea = document.getElementById('profileTemplate');

            const profileData = {
                name: nameInput.value.trim(),
                icon: iconSelect.value,
                description: descriptionInput.value.trim(),
                promptTemplate: templateTextarea.value.trim()
            };

            if (currentEditingProfileId) {
                // Update existing profile
                vscode.postMessage({
                    type: 'updateProfile',
                    profileId: currentEditingProfileId,
                    updates: profileData
                });
            } else {
                // Create new profile
                const newProfile = {
                    id: generateProfileId(profileData.name),
                    ...profileData,
                    isBuiltIn: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                vscode.postMessage({
                    type: 'createProfile',
                    profile: newProfile
                });
            }

            hideProfileForm();
        }

        /**
         * Generate a profile ID from a name
         */
        function generateProfileId(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        /**
         * Update the icon preview
         */
        function updateIconPreview(iconName) {
            const preview = document.getElementById('iconPreview');
            if (preview) {
                preview.className = `codicon codicon-${iconName} icon-preview-icon`;
            }
        }

        // ============================================================================
        // Profile Settings Event Listeners
        // ============================================================================

        // Close profile settings modal
        const closeProfileSettingsBtn = document.getElementById('closeProfileSettingsBtn');
        if (closeProfileSettingsBtn) {
            closeProfileSettingsBtn.addEventListener('click', hideProfileSettings);
        }

        // Create profile button
        const createProfileBtn = document.getElementById('createProfileBtn');
        if (createProfileBtn) {
            createProfileBtn.addEventListener('click', showCreateProfileForm);
        }

        // Close profile form modal
        const closeProfileFormBtn = document.getElementById('closeProfileFormBtn');
        if (closeProfileFormBtn) {
            closeProfileFormBtn.addEventListener('click', hideProfileForm);
        }

        // Cancel profile form
        const cancelProfileFormBtn = document.getElementById('cancelProfileFormBtn');
        if (cancelProfileFormBtn) {
            cancelProfileFormBtn.addEventListener('click', hideProfileForm);
        }

        // Save profile button
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener('click', saveProfile);
        }

        // Icon select change handler
        const profileIconSelect = document.getElementById('profileIcon');
        if (profileIconSelect) {
            profileIconSelect.addEventListener('change', function() {
                updateIconPreview(this.value);
            });
        }

        // Close modals when clicking outside
        const profileSettingsModal = document.getElementById('profileSettingsModal');
        if (profileSettingsModal) {
            profileSettingsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideProfileSettings();
                }
            });
        }

        const profileFormModal = document.getElementById('profileFormModal');
        if (profileFormModal) {
            profileFormModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideProfileForm();
                }
            });
        }

        // Handle Enter key in form inputs (except textarea)
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    saveProfile();
                }
            });
        }

        // ============================================================================
        // Execution History UI Functions
        // ============================================================================

        let executionHistory = [];
        let filteredHistory = [];

        /**
         * Show the execution history modal
         * Requirements: 6.4, 6.5, 6.6
         */
        function showExecutionHistory() {
            const modal = document.getElementById('executionHistoryModal');
            if (modal) {
                modal.style.display = 'flex';
                
                // Request history and statistics from extension
                vscode.postMessage({ type: 'getExecutionHistory' });
                vscode.postMessage({ type: 'getExecutionStatistics' });
                
                // Show list view, hide detail view
                showHistoryListView();
            }
        }

        /**
         * Hide the execution history modal
         */
        function hideExecutionHistory() {
            const modal = document.getElementById('executionHistoryModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        /**
         * Show the history list view
         */
        function showHistoryListView() {
            const listView = document.getElementById('historyListView');
            const detailView = document.getElementById('historyDetailView');
            
            if (listView) listView.style.display = 'block';
            if (detailView) detailView.style.display = 'none';
        }

        /**
         * Show the history detail view
         */
        function showHistoryDetailView() {
            const listView = document.getElementById('historyListView');
            const detailView = document.getElementById('historyDetailView');
            
            if (listView) listView.style.display = 'none';
            if (detailView) detailView.style.display = 'block';
        }

        /**
         * Render the execution history list
         * Requirements: 6.4
         */
        function renderExecutionHistory(entries) {
            executionHistory = entries || [];
            
            // Populate filter dropdowns
            populateHistoryFilters();
            
            // Apply filters
            applyHistoryFilters();
        }

        /**
         * Render execution statistics
         * Requirements: 6.6
         */
        function renderExecutionStatistics(statistics) {
            const statsContainer = document.getElementById('historyStatistics');
            if (!statsContainer) return;

            // Show statistics container
            statsContainer.style.display = 'block';

            // Update overall statistics
            const totalExecutions = document.getElementById('statTotalExecutions');
            const successRate = document.getElementById('statSuccessRate');
            const avgDuration = document.getElementById('statAvgDuration');

            if (totalExecutions) totalExecutions.textContent = statistics.totalExecutions || 0;
            if (successRate) successRate.textContent = (statistics.successRate || 0).toFixed(1);
            if (avgDuration) avgDuration.textContent = formatDuration(statistics.averageDuration || 0);

            // Render per-spec statistics
            const perSpecSection = document.getElementById('perSpecStatsSection');
            const perSpecBody = document.getElementById('perSpecStatsBody');
            
            if (perSpecBody && statistics.bySpec && Object.keys(statistics.bySpec).length > 0) {
                perSpecSection.style.display = 'block';
                
                const specRows = Object.entries(statistics.bySpec)
                    .sort((a, b) => b[1].totalExecutions - a[1].totalExecutions)
                    .map(([specId, stats]) => `
                        <tr>
                            <td>${escapeHtml(stats.specName)}</td>
                            <td>${stats.totalExecutions}</td>
                            <td>${stats.successCount}</td>
                            <td>${stats.failureCount}</td>
                            <td>${formatDuration(stats.averageDuration)}</td>
                        </tr>
                    `).join('');
                
                perSpecBody.innerHTML = specRows;
            } else if (perSpecSection) {
                perSpecSection.style.display = 'none';
            }

            // Render per-profile statistics
            const perProfileSection = document.getElementById('perProfileStatsSection');
            const perProfileBody = document.getElementById('perProfileStatsBody');
            
            if (perProfileBody && statistics.byProfile && Object.keys(statistics.byProfile).length > 0) {
                perProfileSection.style.display = 'block';
                
                const profileRows = Object.entries(statistics.byProfile)
                    .sort((a, b) => b[1].totalExecutions - a[1].totalExecutions)
                    .map(([profileId, stats]) => `
                        <tr>
                            <td>${escapeHtml(stats.profileName)}</td>
                            <td>${stats.totalExecutions}</td>
                            <td>${stats.successCount}</td>
                            <td>${stats.failureCount}</td>
                            <td>${formatDuration(stats.averageDuration)}</td>
                        </tr>
                    `).join('');
                
                perProfileBody.innerHTML = profileRows;
            } else if (perProfileSection) {
                perProfileSection.style.display = 'none';
            }
        }

        /**
         * Populate the history filter dropdowns
         */
        function populateHistoryFilters() {
            const specFilter = document.getElementById('historySpecFilter');
            const profileFilter = document.getElementById('historyProfileFilter');
            
            if (!specFilter || !profileFilter) return;

            // Get unique spec names
            const specNames = [...new Set(executionHistory.map(e => e.specName))].sort();
            specFilter.innerHTML = '<option value="">All Specs</option>' + 
                specNames.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');

            // Get unique profile names
            const profileNames = [...new Set(executionHistory.map(e => e.profileName))].sort();
            profileFilter.innerHTML = '<option value="">All Profiles</option>' + 
                profileNames.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
        }

        /**
         * Apply filters to the history list
         * Requirements: 6.6
         */
        function applyHistoryFilters() {
            const specFilter = document.getElementById('historySpecFilter');
            const profileFilter = document.getElementById('historyProfileFilter');
            const statusFilter = document.getElementById('historyStatusFilter');
            
            const specValue = specFilter ? specFilter.value : '';
            const profileValue = profileFilter ? profileFilter.value : '';
            const statusValue = statusFilter ? statusFilter.value : '';

            // Filter history entries
            filteredHistory = executionHistory.filter(entry => {
                if (specValue && entry.specName !== specValue) return false;
                if (profileValue && entry.profileName !== profileValue) return false;
                if (statusValue && entry.status !== statusValue) return false;
                return true;
            });

            // Sort by timestamp (most recent first) - Requirement 6.4
            filteredHistory.sort((a, b) => {
                const timeA = new Date(a.startTime).getTime();
                const timeB = new Date(b.startTime).getTime();
                return timeB - timeA;
            });

            // Render the filtered list
            renderHistoryList();
        }

        /**
         * Render the history list
         * Requirements: 6.4
         */
        function renderHistoryList() {
            const historyList = document.getElementById('historyList');
            const emptyState = document.getElementById('historyEmptyState');
            
            if (!historyList || !emptyState) return;

            if (filteredHistory.length === 0) {
                historyList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            historyList.innerHTML = filteredHistory.map(entry => {
                const startTime = formatDateTime(entry.startTime);
                const duration = entry.duration ? formatDuration(entry.duration) : 'N/A';
                
                // Status badge
                let statusBadgeHTML = '';
                switch (entry.status) {
                    case 'running':
                        statusBadgeHTML = '<span class="history-status-badge running"><span class="codicon codicon-sync"></span> Running</span>';
                        break;
                    case 'completed':
                        statusBadgeHTML = '<span class="history-status-badge completed"><span class="codicon codicon-check"></span> Completed</span>';
                        break;
                    case 'failed':
                        statusBadgeHTML = '<span class="history-status-badge failed"><span class="codicon codicon-error"></span> Failed</span>';
                        break;
                    case 'cancelled':
                        statusBadgeHTML = '<span class="history-status-badge cancelled"><span class="codicon codicon-circle-slash"></span> Cancelled</span>';
                        break;
                }

                return `
                    <li class="history-item" data-execution-id="${escapeHtml(entry.executionId)}">
                        <div class="history-item-main">
                            <div class="history-item-header">
                                <span class="history-spec-name">${escapeHtml(entry.specName)}</span>
                                ${statusBadgeHTML}
                            </div>
                            <div class="history-profile-name">Profile: ${escapeHtml(entry.profileName)}</div>
                            <div class="history-item-meta">
                                <span>${startTime}</span>
                                <span>Duration: ${duration}</span>
                                <span>${entry.completedTasks}/${entry.totalTasks} tasks</span>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');

            // Attach click handlers
            attachHistoryItemListeners();
        }

        /**
         * Attach click handlers to history items
         */
        function attachHistoryItemListeners() {
            const historyItems = document.querySelectorAll('.history-item');
            historyItems.forEach(item => {
                item.addEventListener('click', function() {
                    const executionId = this.getAttribute('data-execution-id');
                    showHistoryEntryDetail(executionId);
                });
            });
        }

        /**
         * Show detail view for a history entry
         * Requirements: 6.5
         */
        function showHistoryEntryDetail(executionId) {
            const entry = executionHistory.find(e => e.executionId === executionId);
            if (!entry) return;

            const detailContent = document.getElementById('historyDetailContent');
            if (!detailContent) return;

            const startTime = formatDateTime(entry.startTime);
            const endTime = entry.endTime ? formatDateTime(entry.endTime) : 'N/A';
            const duration = entry.duration ? formatDuration(entry.duration) : 'N/A';
            
            // Status badge
            let statusBadgeHTML = '';
            switch (entry.status) {
                case 'running':
                    statusBadgeHTML = '<span class="history-status-badge running"><span class="codicon codicon-sync"></span> Running</span>';
                    break;
                case 'completed':
                    statusBadgeHTML = '<span class="history-status-badge completed"><span class="codicon codicon-check"></span> Completed</span>';
                    break;
                case 'failed':
                    statusBadgeHTML = '<span class="history-status-badge failed"><span class="codicon codicon-error"></span> Failed</span>';
                    break;
                case 'cancelled':
                    statusBadgeHTML = '<span class="history-status-badge cancelled"><span class="codicon codicon-circle-slash"></span> Cancelled</span>';
                    break;
            }

            // Error section (only for failed executions)
            const errorHTML = entry.error ? `
                <div class="history-detail-section">
                    <div class="history-detail-label">Error</div>
                    <div class="history-detail-error">${escapeHtml(entry.error)}</div>
                </div>
            ` : '';

            detailContent.innerHTML = `
                <div class="history-detail-section">
                    <div class="history-detail-label">Spec</div>
                    <div class="history-detail-value">${escapeHtml(entry.specName)}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">Profile</div>
                    <div class="history-detail-value">${escapeHtml(entry.profileName)}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">Workspace Folder</div>
                    <div class="history-detail-value">${escapeHtml(entry.workspaceFolder || 'N/A')}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">Status</div>
                    <div class="history-detail-value">${statusBadgeHTML}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">Start Time</div>
                    <div class="history-detail-value">${startTime}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">End Time</div>
                    <div class="history-detail-value">${endTime}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">Duration</div>
                    <div class="history-detail-value">${duration}</div>
                </div>

                <div class="history-detail-section">
                    <div class="history-detail-label">Task Progress</div>
                    <div class="history-detail-value">${entry.completedTasks} / ${entry.totalTasks} tasks completed</div>
                </div>

                ${errorHTML}
            `;

            showHistoryDetailView();
        }

        /**
         * Format a date/time string for display
         */
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            
            try {
                const date = new Date(isoString);
                return date.toLocaleString();
            } catch (error) {
                return isoString;
            }
        }

        /**
         * Format a duration in milliseconds for display
         */
        function formatDuration(ms) {
            if (!ms || ms < 0) return 'N/A';
            
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // ============================================================================
        // Execution History Event Listeners
        // ============================================================================

        // Execution History button click handler
        const executionHistoryBtn = document.getElementById('executionHistoryBtn');
        if (executionHistoryBtn) {
            executionHistoryBtn.addEventListener('click', () => {
                vscode.postMessage({ type: 'openHistory' });
            });
        }

        // Close execution history modal
        const closeExecutionHistoryBtn = document.getElementById('closeExecutionHistoryBtn');
        if (closeExecutionHistoryBtn) {
            closeExecutionHistoryBtn.addEventListener('click', hideExecutionHistory);
        }

        // Back to history list button
        const backToHistoryListBtn = document.getElementById('backToHistoryListBtn');
        if (backToHistoryListBtn) {
            backToHistoryListBtn.addEventListener('click', showHistoryListView);
        }

        // History filter change handlers
        const historySpecFilter = document.getElementById('historySpecFilter');
        if (historySpecFilter) {
            historySpecFilter.addEventListener('change', applyHistoryFilters);
        }

        const historyProfileFilter = document.getElementById('historyProfileFilter');
        if (historyProfileFilter) {
            historyProfileFilter.addEventListener('change', applyHistoryFilters);
        }

        const historyStatusFilter = document.getElementById('historyStatusFilter');
        if (historyStatusFilter) {
            historyStatusFilter.addEventListener('change', applyHistoryFilters);
        }

        // Close execution history modal when clicking outside
        const executionHistoryModal = document.getElementById('executionHistoryModal');
        if (executionHistoryModal) {
            executionHistoryModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideExecutionHistory();
                }
            });
        }

    </script>
    
    <!-- External Libraries for Markdown Rendering -->
    <!-- These libraries are bundled locally for offline use and security -->
    <script nonce="{{nonce}}" src="{{markedUri}}"></script>
    <script nonce="{{nonce}}" src="{{highlightJsUri}}"></script>
    <script nonce="{{nonce}}" src="{{mermaidUri}}"></script>
    
    <script nonce="{{nonce}}">
        // Configure marked.js for GitHub Flavored Markdown (Requirement 7.4)
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                gfm: true,              // Enable GitHub Flavored Markdown
                breaks: true,           // Convert \n to <br> (GFM line breaks)
                tables: true,           // Enable GFM tables
                pedantic: false,        // Don't conform to obscure parts of markdown.pl
                sanitize: false,        // Don't sanitize HTML (we trust spec content)
                smartLists: true,       // Use smarter list behavior
                smartypants: false      // Don't use smart typography
            });
            
            // Custom renderer for task lists (GFM extension)
            const renderer = new marked.Renderer();
            
            // Override list item rendering to support task lists
            renderer.listitem = function(text, task, checked) {
                if (task) {
                    // Render task list item with checkbox
                    const checkboxHtml = checked 
                        ? '<input type="checkbox" disabled checked> ' 
                        : '<input type="checkbox" disabled> ';
                    return '<li class="task-list-item">' + checkboxHtml + text + '</li>\n';
                }
                return '<li>' + text + '</li>\n';
            };
            
            // Override list rendering to add task-list class
            const originalList = renderer.list;
            renderer.list = function(body, ordered, start) {
                const hasTaskItems = body.includes('class="task-list-item"');
                const listTag = ordered ? 'ol' : 'ul';
                const startAttr = (ordered && start !== 1) ? ' start="' + start + '"' : '';
                const className = hasTaskItems ? ' class="task-list"' : '';
                return '<' + listTag + startAttr + className + '>\n' + body + '</' + listTag + '>\n';
            };
            
            // Override table rendering to add IDE-style classes
            renderer.table = function(header, body) {
                return '<table class="markdown-table">\n'
                    + '<thead>\n'
                    + header
                    + '</thead>\n'
                    + '<tbody>\n'
                    + body
                    + '</tbody>\n'
                    + '</table>\n';
            };
            
            // Override link rendering to handle autolinks
            renderer.link = function(href, title, text) {
                const titleAttr = title ? ' title="' + title + '"' : '';
                return '<a href="' + href + '"' + titleAttr + ' target="_blank" rel="noopener noreferrer">' + text + '</a>';
            };
            
            marked.use({ renderer });
            
            console.log('marked.js configured for GitHub Flavored Markdown');
        } else {
            console.error('marked.js library not loaded');
        }
        
        /**
         * Render markdown content to HTML
         * @param {string} markdown - Raw markdown content
         * @returns {string} Rendered HTML
         */
        function renderMarkdown(markdown) {
            if (!markdown || typeof marked === 'undefined') {
                return '';
            }
            
            try {
                return marked.parse(markdown);
            } catch (error) {
                console.error('Error rendering markdown:', error);
                
                // Report error to extension
                vscode.postMessage({
                    type: 'webviewError',
                    error: {
                        message: 'Markdown rendering failed: ' + (error.message || String(error)),
                        stack: error.stack || ''
                    }
                });
                
                return '<div class="error-message">Failed to render markdown content. The content may contain invalid syntax.</div>';
            }
        }
        
        // Configure highlight.js for syntax highlighting (Requirement 7.5)
        // Wait for hljs to be available
        function configureHighlightJs() {
            if (typeof hljs !== 'undefined') {
                // Configure highlight.js with automatic language detection
                hljs.configure({
                    ignoreUnescapedHTML: true,  // Ignore unescaped HTML in code blocks
                    languages: undefined,        // Use all available languages
                    classPrefix: 'hljs-'        // CSS class prefix for syntax elements
                });
                
                console.log('highlight.js configured for syntax highlighting');
            } else {
                console.warn('highlight.js library not loaded yet, will retry');
                // Retry after a short delay
                setTimeout(configureHighlightJs, 100);
            }
        }
        
        configureHighlightJs();
        
        /**
         * Apply syntax highlighting to all code blocks in a container
         * @param {HTMLElement} container - Container element with code blocks
         */
        function applySyntaxHighlighting(container) {
            if (typeof hljs === 'undefined') {
                console.warn('highlight.js not available, skipping syntax highlighting');
                return;
            }
            
            try {
                // Find all code blocks
                const codeBlocks = container.querySelectorAll('pre code');
                
                codeBlocks.forEach(block => {
                    try {
                        // Apply syntax highlighting with automatic language detection
                        hljs.highlightElement(block);
                    } catch (blockError) {
                        console.error('Error highlighting code block:', blockError);
                        // Continue with other blocks even if one fails
                    }
                });
                
                console.log(`Applied syntax highlighting to ${codeBlocks.length} code block(s)`);
            } catch (error) {
                console.error('Error applying syntax highlighting:', error);
                
                // Report error to extension
                vscode.postMessage({
                    type: 'webviewError',
                    error: {
                        message: 'Syntax highlighting failed: ' + (error.message || String(error)),
                        stack: error.stack || ''
                    }
                });
            }
        }
        
        /**
         * Render markdown with syntax highlighting and sanitization
         * @param {string} markdown - Raw markdown content
         * @returns {string} Rendered HTML with syntax highlighting and sanitization
         * 
         * Requirements: 7.4, 7.5, 10.5
         */
        function renderMarkdownWithHighlighting(markdown) {
            if (!markdown) {
                return '';
            }
            
            // First render markdown to HTML
            const html = renderMarkdown(markdown);
            
            // Sanitize the HTML to prevent XSS attacks (Requirement 10.5)
            const sanitizedHtml = sanitizeHtml(html);
            
            // Create a temporary container to apply syntax highlighting
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = sanitizedHtml;
            
            // Apply syntax highlighting to code blocks
            applySyntaxHighlighting(tempDiv);
            
            return tempDiv.innerHTML;
        }
        
        // Configure mermaid.js for diagram rendering (Requirement 7.3)
        function configureMermaid() {
            if (typeof mermaid === 'undefined') {
                console.warn('mermaid.js library not loaded yet, will retry');
                setTimeout(configureMermaid, 100);
                return;
            }
            
            try {
                // Get VSCode theme colors for mermaid diagrams
                const isDarkTheme = document.body.classList.contains('vscode-dark') || 
                                   document.body.classList.contains('vscode-high-contrast');
                
                // Get computed styles to resolve CSS variables
                const computedStyle = getComputedStyle(document.body);
                const backgroundColor = computedStyle.getPropertyValue('--vscode-editor-background').trim() || '#1e1e1e';
                const foregroundColor = computedStyle.getPropertyValue('--vscode-foreground').trim() || '#d4d4d4';
                const borderColor = computedStyle.getPropertyValue('--vscode-panel-border').trim() || '#454545';
                
                mermaid.initialize({
                    startOnLoad: false,     // Don't auto-render on page load
                    theme: isDarkTheme ? 'dark' : 'default',  // Match IDE theme
                    securityLevel: 'loose', // Allow HTML in diagrams
                    fontFamily: 'var(--vscode-font-family)',
                    fontSize: 13,
                    logLevel: 'error',      // Only log errors
                    // Theme variables to match VSCode colors
                    themeVariables: {
                        primaryColor: borderColor,
                        primaryTextColor: foregroundColor,
                        primaryBorderColor: borderColor,
                        lineColor: borderColor,
                        secondaryColor: backgroundColor,
                        tertiaryColor: backgroundColor,
                        background: backgroundColor,
                        mainBkg: backgroundColor,
                        secondBkg: backgroundColor,
                        mainContrastColor: foregroundColor,
                        darkMode: isDarkTheme,
                        fontFamily: 'var(--vscode-font-family)'
                    }
                });
                
                console.log('mermaid.js configured for diagram rendering');
            } catch (error) {
                console.error('Error configuring mermaid.js:', error);
            }
        }
        
        configureMermaid();
        
        /**
         * Render mermaid diagrams in a container
         * @param {HTMLElement} container - Container element with mermaid code blocks
         */
        async function renderMermaidDiagrams(container) {
            if (typeof mermaid === 'undefined') {
                console.warn('mermaid.js not available, skipping diagram rendering');
                return;
            }
            
            try {
                // Find all code blocks with language 'mermaid'
                const mermaidBlocks = container.querySelectorAll('pre code.language-mermaid, pre code.mermaid');
                
                if (mermaidBlocks.length === 0) {
                    return;
                }
                
                console.log(`Found ${mermaidBlocks.length} mermaid diagram(s) to render`);
                
                for (let i = 0; i < mermaidBlocks.length; i++) {
                    const block = mermaidBlocks[i];
                    const code = block.textContent;
                    
                    try {
                        // Create a unique ID for this diagram
                        const diagramId = 'mermaid-diagram-' + Date.now() + '-' + i;
                        
                        // Render the diagram
                        const { svg } = await mermaid.render(diagramId, code);
                        
                        // Replace the code block with the rendered SVG
                        const diagramDiv = document.createElement('div');
                        diagramDiv.className = 'mermaid-diagram';
                        diagramDiv.innerHTML = svg;
                        
                        // Replace the pre element (parent of code block)
                        const preElement = block.parentElement;
                        if (preElement && preElement.tagName === 'PRE') {
                            preElement.replaceWith(diagramDiv);
                        }
                    } catch (error) {
                        console.error('Error rendering mermaid diagram:', error);
                        
                        // Report error to extension
                        vscode.postMessage({
                            type: 'webviewError',
                            error: {
                                message: 'Mermaid diagram rendering failed: ' + (error.message || String(error)),
                                stack: error.stack || ''
                            }
                        });
                        
                        // Show error message in place of diagram (Requirement 11.3)
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = 'Failed to render diagram. The diagram syntax may be invalid.';
                        
                        const preElement = block.parentElement;
                        if (preElement && preElement.tagName === 'PRE') {
                            preElement.replaceWith(errorDiv);
                        }
                    }
                }
                
                console.log('Mermaid diagram rendering complete');
            } catch (error) {
                console.error('Error in renderMermaidDiagrams:', error);
                
                // Report error to extension
                vscode.postMessage({
                    type: 'webviewError',
                    error: {
                        message: 'renderMermaidDiagrams failed: ' + (error.message || String(error)),
                        stack: error.stack || ''
                    }
                });
            }
        }
        
        /**
         * Render markdown with syntax highlighting and mermaid diagrams
         * @param {string} markdown - Raw markdown content
         * @param {HTMLElement} targetElement - Target element to render into
         */
        async function renderMarkdownComplete(markdown, targetElement) {
            if (!markdown || !targetElement) {
                return;
            }
            
            // First render markdown with syntax highlighting
            const html = renderMarkdownWithHighlighting(markdown);
            
            // Set the HTML content
            targetElement.innerHTML = html;
            
            // Then render mermaid diagrams
            await renderMermaidDiagrams(targetElement);
        }
    </script>
</body>
</html>
